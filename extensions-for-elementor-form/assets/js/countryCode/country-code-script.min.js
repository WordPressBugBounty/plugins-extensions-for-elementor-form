class CCFEF extends elementorModules.frontend.handlers.Base{getDefaultSettings(){return{selectors:{intlInputSpan:".ccfef-editor-intl-input",submitButton:"div.elementor-field-type-submit button"}}}getDefaultElements(){const e=this.getSettings("selectors");return{$intlSpanElement:this.$element.find(e.intlInputSpan),$submitButton:this.$element.find(e.submitButton)}}bindEvents(){this.initializeITISettings(),this.setupInternationalTelephoneInput(),this.customFlags(),this.cleanupDOMElements(),this.validateInternationalInputs()}initializeITISettings(){this.itiSettingData={Id:[],defaultCountry:{},includeCountries:{},excludeCountries:{},preferredCountries:{},autoDetectCountry:{},apiKey:CCFEFCustomData.geo_lookup_key},this.itiObj={},this.getIntlUserData()}setupInternationalTelephoneInput(){this.appendCountryCodeHandler(),this.addCountryCodeInputHandler()}cleanupDOMElements(){this.$element.find("span.ccfef-editor-intl-input").remove()}appendCountryCodeHandler(){this.itiSettingData.Id.forEach(e=>{this.addCountryCodeIconHandler(e.formId,e.fieldId,e.customId)})}addCountryCodeIconHandler(e,t,n){const i=`${CCFEFCustomData.pluginDir}assets/js/countryCode/utils.js`,o=jQuery(`.elementor-widget.elementor-widget-cool-form[data-id="${e}"] .cool-form__field-group input[type="tel"]#${n}`).get(0),r=this.itiSettingData;if(o){const n=`${e}${t}`,s=r.includeCountries[n]||[],a=r.excludeCountries[n]||[],l=r.preferredCountries[n]||[],d={utilsScript:i,separateDialCode:!0,formatOnDisplay:!1,formatAsYouType:!0,autoFormat:!1,containerClass:"cfefp-intl-container",useFullscreenPopup:!1,onlyCountries:s,excludeCountries:a,customPlaceholder:(e,t)=>{let n=e;return n=n.replace(/^0+/,""),""!==n?`+${t.dialCode} ${n}`.replace(/\s/g,""):""}},u=window.intlTelInput(o,d);this.itiObj[n]=u,l.length&&this.reorderPreferredCountries(u,l),this.setInitialCountry(u,a,n)}}reorderPreferredCountries(e,t){const n=jQuery(e.countryList);t.reverse().forEach((e,t)=>{const i=n.find(`li[data-country-code="${e}"]`);i.length&&(0===t&&n.prepend("<hr></hr>"),n.prepend(i))})}setInitialCountry(e,t,n){const i=this.itiSettingData.defaultCountry[n]||"",o=this.itiSettingData.autoDetectCountry[n]||"",r=this.itiSettingData.apiKey,s=["in","us","gb","ru","fr","de","br","cn","jp","it"],a=e.p.map(e=>e.iso2),l=n=>{if(a.length<=0)return;e.a;const o=n?n.toLowerCase():"";if(o&&a.includes(o))e.setCountry(o);else if(i&&a.includes(i))e.setCountry(i);else{const n=s.filter(e=>!t.includes(e)&&a.includes(e)),i=n.length>0?n[0]:a[0];e.setCountry(i)}};if(o&&"no"!==o){const e=r.trim(),t=e&&""!==e?`https://ipapi.co/json/?key=${e}`:"https://ipapi.co/json";fetch(t).then(e=>e.json()).then(e=>{l(e.country_code)}).catch(e=>{console.error("Error fetching geo IP data:",e),l(i||a[0])})}else i&&l(i)}addCountryCodeInputHandler(){const e=this.itiObj;Object.keys(e).forEach(t=>{const n=e[t],i=n.a;let o=n.getSelectedCountryData(),r=`+${o.dialCode}`,s=!1;const a=()=>{s=!1},l=e=>{this.customFlags();const t=n.getSelectedCountryData(),i=`+${t.dialCode}`;if("keydown"===e.type||"input"===e.type)s=!0,clearTimeout(a),setTimeout(a,400),o.dialCode!==t.dialCode?o=t:o.dialCode===t.dialCode&&o.iso2!==t.iso2&&n.setCountry(o.iso2);else if("countrychange"===e.type){if(s)return;o=t}this.updateCountryCodeHandler(e.currentTarget,i,r),r=i};i.addEventListener("keydown",l),i.addEventListener("input",l),i.addEventListener("countrychange",l)})}updateCountryCodeHandler(e,t,n){let i=e.value;t&&"+undefined"===t||["","+"].includes(i)||(t!==n&&(i=i.replace(new RegExp(`^\\${n}`),"")),i.startsWith(t)||(i=i.replace(/\+/g,""),e.value=t+i))}customFlags(){const e=this.$element.find(".elementor-field-type-tel .cfefp-intl-container .iti__country-container .iti__flag:not(.iti__globe)");e.each(function(){const e=this,t=e.className.split(" ");if(t[1]){const n=t[1].split("__")[1],i=CCFEFCustomData.pluginDir+`assets/flags/${n}.svg`;e.style.backgroundImage=`url('${i}')`}})}getIntlUserData(){const e=this.elements.$intlSpanElement,t=[];e.each((e,n)=>{const i=jQuery(n),o={defaultCountry:i.data("defaultCountry"),includeCountries:i.data("includeCountries"),excludeCountries:i.data("excludeCountries"),preferredCountries:i.data("preferredCountries"),autoDetectCountry:i.data("autoDetect"),inputId:i.data("id"),fieldId:i.data("field-id"),formId:i.closest(".elementor-element.elementor-widget-cool-form").data("id")},r=`${o.formId}${o.fieldId}`;Object.keys(o).forEach(e=>{if(o[e]&&"inputId"!==e&&"fieldId"!==e&&"formId"!==e&&""!==o[e]){const t=["defaultCountry","autoDetectCountry"].includes(e)?o[e]:o[e].split(",");this.itiSettingData[e][r]=t}}),t.includes(r)||(this.itiSettingData.Id.push({formId:o.formId,fieldId:o.fieldId,customId:o.inputId}),t.push(r))})}validateInternationalInputs(){this.elements.$submitButton.on("click",e=>{const t=this.itiObj;Object.keys(t).length>0&&Object.keys(t).forEach(n=>{const i=t[n],o=i.a;""!==o.value&&(o.value=o.value.replace(/[^0-9+]/g,""));const r=o.closest(".elementor-field-group"),s=r.querySelector(".cfefp-intl-container");s&&o.offsetHeight&&s.style.setProperty("--cfefp-intl-tel-button-height",`${o.offsetHeight}px`);const a=jQuery(o).parent();a.find("span.elementor-message").remove();const l=CCFEFCustomData.errorMap;let d='<span class="elementor-message elementor-message-danger elementor-help-inline elementor-form-help-inline" role="alert">';if(""!==o.value.trim())if(i.isValidNumber())jQuery(o).closest(".cfefp-intl-container").removeClass("elementor-error");else{const t=i.getValidationError();void 0!==t&&l[t]&&(d+=l[t]+"</span>",jQuery(o).closest(".cfefp-intl-container").addClass("elementor-error"),jQuery(o).after(d),e.preventDefault())}})})}}jQuery(window).on("elementor/frontend/init",()=>{const e=e=>{elementorFrontend.elementsHandler.addHandler(CCFEF,{$element:e})};elementorFrontend.hooks.addAction("frontend/element_ready/cool-form.default",e)});